{% extends "base.html" %}
{% block title %}{{ deck.name }}{% endblock %}

{% block content %}
<h1>{{ deck.name }}</h1>

<form id="add-flashcard">
    <label for="front">Front of Card:</label>
    <textarea name="front" id="front" class="form-control"></textarea>
    <br />
    <label for="back">Back of Card:</label>
    <textarea name="back" id="back" class="form-control"></textarea>
    <br />
    <div align="center">
        <button type="submit" class="btn btn-primary">Add Card</button>
        <a href="{{ url_for('views.study', deck_id=deck.id) }}" class="btn btn-primary">Study</a> 
    </div>
</form>
<br />
<div class="container">
    <div class="row" id="flashcard-container">
        {% for flashcard in flashcards %}
        <div class="col-md-4" id="flashcard-{{ flashcard.id }}">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">{{ flashcard.front }}</h5>
                    <p class="card-text">{{ flashcard.back }}</p>
                    <button class="btn btn-danger" onclick="deleteFlashcard({{ flashcard.id }})">Delete</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block javascript %}
<script> 
//This uses fetch to send the flashcardId to the back end, then removes the element from the DOM when it gets a good response.
//Takes in a flashcardId as a parameter
function deleteFlashcard(flashcardId) {
    fetch("/delete-flashcard", {
        //Though we are deleting a flashcard, we send a POST request
        method: "POST",
        // For fetch to work it must be a JSON string. The backend can use this to find the flashcard in the database.
        body: JSON.stringify({ flashcardId: flashcardId }),
        // Tell the server what type of data we are sending
        headers: {
            "Content-Type": "application/json",
        }
    })
    //If the response is good, remove the element from the DOM
    .then((_res) => {
        if(_res.ok) {
            document.getElementById("flashcard-" + flashcardId).remove()
        } else {
            alert("Failed to delete flashcard");
        }
    })
    .catch((_err) => {
        alert("Error occurred: " + error);
    });
}
</script>

<!--This will create a new card in the deck-->
<script>
// Add event lister to the form. It will inturrupt the normal form submission
//Event is the event that triggers the function, in this case it is a submit
document.getElementById("add-flashcard").addEventListener("submit", function(event) {
    event.preventDefault(); // Prevent the default form submission that would refresh the page

    //Get the values from the form based on the id
    let front = document.getElementById("front").value;
    let back = document.getElementById("back").value;

    // Send the data to the back end in a fetch POST request. 
    //The deck value was passed in when by views.py when the template was rendered so deck.id will pass the 
    //id of the deck to the back end
    fetch("/deck/{{ deck.id }}", {
        method: "POST",
        body: JSON.stringify({ front: front, back: back }),
        headers: {
            "Content-Type": "application/json",
        }
    })
    //Parses the JSON response and resolves with a javascript object
    .then((response) => response.json())
    //data refers to the javascript object
    .then((data) => {
        //Update the DOM
        if (data.success) {
            // Create a new flashcard element and add it to the DOM
            let flashcardContainer = document.getElementById("flashcard-container");
            let newFlashcard = document.createElement("div");
            newFlashcard.className = "col-md-4";
            newFlashcard.id = "flashcard-" + data.flashcard.id;

            // All values with $ are Javascript placeholders.
            newFlashcard.innerHTML = `
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">${data.flashcard.front}</h5>
                        <p class="card-text">${data.flashcard.back}</p>
                        <button class="btn btn-danger" onclick="deleteFlashcard(${data.flashcard.id})">Delete</button>
                    </div>
                </div>
            `;
            //Actually adds the flashcard to the DOM
            flashcardContainer.appendChild(newFlashcard);

            //Clear the form but setting the values to empty strings
            document.getElementById("front").value = "";
            document.getElementById("back").value = "";
            
        //If the response is not good, alert the user
        } else {
            alert("Failed to add flashcard");
        }
    })
    .catch((error) => {
        alert("Error occurred: " + error);
    });
});

</script>
{% endblock %}
